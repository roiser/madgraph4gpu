name: Code Generator CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-and-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout codegen repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      
      - name: Run code generator
        run: |
          if [ ! -e MG5aMC/mg5amcnlo/PLUGIN/CUDACPP_SA_OUTPUT ] ; then pushd MG5aMC/mg5amcnlo/PLUGIN/ && ln -s ../../../epochX/cudacpp/CODEGEN/PLUGIN/CUDACPP_SA_OUTPUT && popd ; fi
          ./MG5aMC/mg5amcnlo/bin/mg5_aMC test/processes/pp_ttx/output.mg5
      
      - name: Check code format with clang-format
        id: format-check
        run: |
          cd PROC_pp_ttx
          # Find all generated C/C++ files (adjust pattern as needed)
          find . -type f \( -name "*.cc" -o -name "*.h" \) > files.txt
          
          # Run clang-format check
          #if find . -name '*.cc' -o -name '*.h' | xargs -n1 clang-format -style=file -assume-filename={} {} | diff -u {} -; then
          if clang-format --dry-run --Werror $(cat files.txt) 2>&1 | tee format-output.txt; then
            echo "format_ok=true" >> $GITHUB_OUTPUT
            echo "✅ Code is properly formatted"
          else
            echo "format_ok=false" >> $GITHUB_OUTPUT
            echo "❌ Code needs formatting"
            
            # Generate the diff for needed changes
            clang-format -i $(cat files.txt)
            git diff > format-changes.patch
          fi
      
      - name: Commit to target repository
        # if: steps.format-check.outputs.format_ok == 'true'
        env:
          TARGET_REPO: roiser/madgraph4gpu-generated-processes
          GH_TOKEN: ${{ secrets.MG4GPU_GEN_PAT }} ## ${{ secrets.GITHUB_TOKEN }}  # Or use a PAT: secrets.TARGET_REPO_PAT
          #persist-credentials: true
        run: |
          # Configure git
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          
          # Clone target repo
          #git clone https://x-access-token:${{ secrets.PAT_FOR_PUSH }}@github.com/roiser/madgraph4gpu-generated-processes.git
          git clone https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git
          cd madgraph4gpu-generated-processes

          touch foo
          git add foo
          git commit -m "Initial commit" -a 
          git push origin main

          # echo ls
          # ls

          # echo git status
          # git status
          
          # # Create branch based on PR number
          # BRANCH_NAME="codegen-pr-${{ github.event.pull_request.number }}"
          # git checkout -b ${BRANCH_NAME}
          
          # # Copy generated files (adjust paths as needed)
          # cp -r ${GITHUB_WORKSPACE}/PROC_pp_ttx .

          # # Commit and push
          # git add .
          # git commit -m "Code generated from PR #${{ github.event.pull_request.number }}" 
          # # \
          # #           -m "Source PR: ${{ github.event.pull_request.html_url }}"

          # echo git status
          # git status

          # echo pwd
          # pwd

          # echo git remote -v
          # git remote -v

          # git push origin ${BRANCH_NAME}
          
          # echo "✅ Pushed to ${TARGET_REPO} on branch ${BRANCH_NAME}"
      
      - name: Comment on PR with format issues
        if: steps.format-check.outputs.format_ok == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const patch = fs.readFileSync('format-changes.patch', 'utf8');
            
            const comment = `## ❌ Code Format Check Failed
            
            The generated code does not conform to clang-format rules.
            
            <details>
            <summary>Required formatting changes</summary>
            
            \`\`\`diff
            ${patch}
            \`\`\`
            
            </details>
            
            Please update your code generator to produce properly formatted code.`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Fail if format check failed
        if: steps.format-check.outputs.format_ok == 'false'
        run: exit 1
